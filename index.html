<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ¦´ Pixi Spine Previewer</title>

  <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.9/dist/browser/pixi.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@pixi-spine/all-3.8@3.1.2/dist/pixi-spine.umd.js"></script>
  
  <link rel="stylesheet" href="https://torchiad.github.io/sprite-splitter/style.css" />

  <style>
    #canvas-container {
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 1rem;
      box-shadow: var(--shadow);
      height: 600px;
      overflow: hidden;
    }
    canvas {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="title">Pixi Spine Previewer <span class="scissors-icon">ðŸ¦´</span></h1>
      <p class="subtitle">
        Load your <strong>.json</strong>, <strong>.atlas</strong>, and <strong>.png</strong> files to preview and test animations.
      </p>
    </header>

    <div class="card">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ðŸ“‚</div>
        <div class="upload-text">Drop your Spine export files here</div>
        <div class="upload-hint">.json + .atlas + textures (.png)</div>
        <input type="file" id="fileInput" class="file-input" multiple />
      </div>

      <div class="file-status" id="fileStatus">
        <div class="file-info">âœ… Files loaded successfully</div>
        <div class="json-info" id="jsonInfo"></div>
      </div>
    </div>

    <div class="card">
      <div class="buttons">
        <select id="animationSelect" class="btn btn-secondary"></select>
        <button id="playBtn" class="btn btn-primary">â–¶ Play</button>
        <button id="clearBtn" class="btn btn-clear">Clear</button>
      </div>
      <div id="canvas-container"></div>
    </div>

    <div class="version">PixiJS 6.5.9 â€¢ pixi-spine 3.1.2</div>
  </div>

  <script>
    let app, spine, jsonFile, atlasFile, imageFiles = {};
    const input = document.getElementById("fileInput");
    const animSelect = document.getElementById("animationSelect");
    const playBtn = document.getElementById("playBtn");
    const clearBtn = document.getElementById("clearBtn");
    const uploadArea = document.getElementById("uploadArea");
    const fileStatus = document.getElementById("fileStatus");
    const jsonInfo = document.getElementById("jsonInfo");

    // Initialize PIXI app
    app = new PIXI.Application({ backgroundAlpha: 0, width: 800, height: 600 });
    document.getElementById("canvas-container").appendChild(app.view);

    // Drag/drop styling
    uploadArea.addEventListener("dragover", e => {
      e.preventDefault();
      uploadArea.classList.add("dragover");
    });
    uploadArea.addEventListener("dragleave", () => uploadArea.classList.remove("dragover"));
    uploadArea.addEventListener("drop", e => {
      e.preventDefault();
      uploadArea.classList.remove("dragover");
      handleFiles(e.dataTransfer.files);
    });
    input.addEventListener("change", e => handleFiles(e.target.files));
    clearBtn.addEventListener("click", reset);

    function handleFiles(files) {
      for (let f of files) {
        if (f.name.endsWith(".json")) jsonFile = f;
        else if (f.name.endsWith(".atlas")) atlasFile = f;
        else if (f.name.endsWith(".png")) imageFiles[f.name] = f;
      }
      if (jsonFile && atlasFile && Object.keys(imageFiles).length) loadSpine();
    }

    async function loadSpine() {
      uploadArea.classList.add("has-file");
      fileStatus.classList.add("show");
      jsonInfo.innerHTML = `
        <h4>Loaded Files</h4>
        <div class="json-detail"><span>JSON:</span><span>${jsonFile.name}</span></div>
        <div class="json-detail"><span>Atlas:</span><span>${atlasFile.name}</span></div>
        <div class="json-detail"><span>Images:</span><span>${Object.keys(imageFiles).join(", ")}</span></div>
      `;

      const jsonText = await jsonFile.text();
      const atlasText = await atlasFile.text();

      const atlasImages = {};
      for (let [name, file] of Object.entries(imageFiles)) {
        const blob = new Blob([await file.arrayBuffer()]);
        atlasImages[name] = await createImageBitmap(blob);
      }

      // Note: PIXI.spine.core classes are available due to the correct import
      const atlas = new PIXI.spine.core.TextureAtlas(atlasText, (line, cb) => {
        const bmp = atlasImages[line];
        if (!bmp) {
          console.warn("Missing image", line);
          return cb(null);
        }
        const baseTex = new PIXI.BaseTexture(bmp);
        cb(new PIXI.spine.core.Texture(baseTex));
      });

      const atlasLoader = new PIXI.spine.core.AtlasAttachmentLoader(atlas);
      const jsonLoader = new PIXI.spine.core.SkeletonJson(atlasLoader);
      const skeletonData = jsonLoader.readSkeletonData(JSON.parse(jsonText));

      // This PIXI.spine.Spine class is now correctly defined
      spine = new PIXI.spine.Spine(skeletonData);
      spine.x = app.screen.width / 2;
      spine.y = app.screen.height - 100;
      spine.scale.set(0.5);

      app.stage.removeChildren();
      app.stage.addChild(spine);

      animSelect.innerHTML = "";
      for (const anim of spine.spineData.animations) {
        const opt = document.createElement("option");
        opt.value = anim.name;
        opt.textContent = anim.name;
        animSelect.appendChild(opt);
      }
    }

    playBtn.addEventListener("click", () => {
      if (!spine) return;
      const anim = animSelect.value;
      spine.state.setAnimation(0, anim, true);
    });

    function reset() {
      jsonFile = atlasFile = spine = null;
      imageFiles = {};
      animSelect.innerHTML = "";
      app.stage.removeChildren();
      uploadArea.classList.remove("has-file");
      fileStatus.classList.remove("show");
      jsonInfo.innerHTML = "";
    }
  </script>
</body>
</html>